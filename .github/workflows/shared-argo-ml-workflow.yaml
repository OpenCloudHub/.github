name: Shared MLOPS Pipeline

on:
  workflow_call:
    inputs:
      repo_name:  
        description: 'GitHub repository name'
        required: true
        type: string
      model_name:
        description: 'Model name (e.g., wine-classifier)'
        required: true
        type: string
      experiment_name:
        description: 'MLflow experiment name'
        required: true
        type: string
      dvc_data_version:
        description: "Data version to use for training"
        required: true
        type: string
      compute_type:
        description: 'Compute configuration'
        required: true
        type: string
      approval_mode:
        description: 'Approval mode (manual or automatic)'
        required: false
        type: string
        default: 'manual'
      comparison_metric:
        description: 'Metric to compare (accuracy, f1_score, etc.)'
        required: false
        type: string
        default: 'accuracy'
      higher_is_better:
        description: 'Whether higher metric values are better (true/false)'
        required: false
        type: boolean
        default: true
      comparison_threshold:
        description: 'Minimum improvement threshold (e.g., 0.05 = 5%)'
        required: false
        type: string
        default: '0.05'
      training_image:
        description: 'Docker image with training code'
        required: true
        type: string
      training_entrypoint:
        description: 'Training script entrypoint'
        required: true
        type: string
      training_args:
        description: 'Additional training arguments'
        required: false
        type: string
        default: ''

jobs:
  submit-workflow:
    name: ğŸš€ Submit ML Lifecycle Workflow
    runs-on: self-hosted-local
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p ~/.local/bin
          mv kubectl ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          ~/.local/bin/kubectl cluster-info

      - name: Submit Argo Workflow
        id: submit
        run: |
          WORKFLOW_NAME=${{ inputs.model_name }}-$(date +%s)

          cat <<EOF | ~/.local/bin/kubectl create -n ai -f -
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: ${{ inputs.model_name }}-
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
              model: "${{ inputs.model_name }}"
          spec:
            serviceAccountName: workflow-executor
            workflowTemplateRef:
              name: mlops-pipeline
            arguments:
              parameters:
              - name: repo_name
                value: "${{ inputs.repo_name }}"
              - name: model_name
                value: "${{ inputs.model_name }}"
              - name: experiment_name
                value: "${{ inputs.experiment_name }}"
              - name: dvc_data_version:
                value: "${{ inputs.dvc_data_version }}"
              - name: compute_type
                value: "${{ inputs.compute_type }}"
              - name: approval_mode
                value: "${{ inputs.approval_mode }}"
              - name: comparison_metric
                value: "${{ inputs.comparison_metric }}"
              - name: higher_is_better
                value: "${{ inputs.higher_is_better }}"
              - name: comparison_threshold
                value: "${{ inputs.comparison_threshold }}"
              - name: training_image
                value: "${{ inputs.training_image }}"
              - name: training_entrypoint
                value: "${{ inputs.training_entrypoint }}"
              - name: training_args
                value: "${{ inputs.training_args }}"
          EOF

          # Get the actual workflow name
          sleep 2
          ACTUAL_NAME=$(~/.local/bin/kubectl get workflows -n ai -l repo=${{ github.event.repository.name }},run-id=${{ github.run_id }} -o jsonpath='{.items[0].metadata.name}')
          echo "workflow_name=${ACTUAL_NAME}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Provide Monitoring Commands
        run: |
          WORKFLOW_NAME=${{ steps.submit.outputs.workflow_name }}

          echo "========================================="
          echo "ğŸš€ ARGO WORKFLOW SUBMITTED: ${WORKFLOW_NAME}"
          echo "ğŸ¯ Model: ${{ inputs.model_name }}"
          echo "ğŸ’» Compute: ${{ inputs.compute_type }}"
          echo "ğŸ·ï¸  Image: ${{ inputs.training_image }}"
          echo "ğŸ”§ Approval: ${{ inputs.approval_mode }}"
          echo "========================================="
          echo ""
          echo "ğŸ“‹ MONITORING COMMANDS:"
          echo ""
          echo "ğŸ” CHECK STATUS:"
          echo "   kubectl get workflow -n ai ${WORKFLOW_NAME}"
          echo ""
          echo "ğŸ“ VIEW LOGS:"
          echo "   kubectl logs -n ai -l workflows.argoproj.io/workflow=${WORKFLOW_NAME} -f"
          echo ""
          echo "ğŸŒ ARGO UI:"
          echo "   https://argo.ai.internal.opencloudhub.org"
          echo ""
          echo "ğŸ”¬ MLFLOW UI:"
          echo "   kubectl port-forward -n ai svc/mlflow 5000:5000"
          echo "   http://localhost:5000"
          echo ""
          echo "âœ… APPROVE WORKFLOW (if manual approval):"
          echo "   argo resume -n ai ${WORKFLOW_NAME}"
          echo ""
          echo "ğŸ§¹ CLEANUP:"
          echo "   kubectl delete workflow -n ai ${WORKFLOW_NAME}"
          echo "========================================"
