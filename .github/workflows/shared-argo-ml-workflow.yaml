name: Shared MLOPS Pipeline

on:
  workflow_call:
    inputs:
      model_name:
        description: 'Model name (e.g., wine-classifier)'
        required: true
        type: string
      dvc_data_version:
        description: "Data version to use for training"
        required: true
        type: string
      experiment_name:
        description: 'MLflow experiment name'
        required: true
        type: string
      training_entrypoint:
        description: 'Training script entrypoint'
        required: true
        type: string
      training_args:
        description: 'Additional training arguments'
        required: false
        type: string
        default: ''
      image_tag:
        description: 'Image tag to use (latest, main-abc1234, etc.)'
        required: true
        type: string
        default: 'latest'
      compute_type:
        description: 'Compute configuration'
        required: true
        type: string
      approval_mode:
        description: 'Approval mode (manual or automatic)'
        required: false
        type: string
        default: 'manual'
      comparison_metric:
        description: 'Metric to compare (accuracy, f1_score, etc.)'
        required: false
        type: string
        default: 'accuracy'
      comparison_higher_is_better:
        description: 'Whether higher metric values are better (true/false)'
        required: false
        type: boolean
        default: true
      comparison_threshold:
        description: 'Minimum improvement threshold (e.g., 0.05 = 5%)'
        required: false
        type: string
        default: '0.05'
      
jobs:
  submit-workflow:
    name: ğŸš€ Submit ML Lifecycle Workflow
    runs-on: self-hosted-local
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p ~/.local/bin
          mv kubectl ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          ~/.local/bin/kubectl cluster-info

      - name: Resolve and validate image tag
        id: resolve_image
        run: |
          INPUT_TAG="${{ inputs.image_tag }}"
          # Docker repo name always determined by model name
          DOCKER_REPO="${{ secrets.DOCKER_USERNAME }}/${{ inputs.model_name }}"
          
          if [ "$INPUT_TAG" = "latest" ]; then
            # Get latest commit SHA from main branch
            COMMIT_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/commits/main" \
              | jq -r '.sha[0:7]')
            
            RESOLVED_TAG="main-${COMMIT_SHA}"
            echo "âœ… Resolved 'latest' to: ${RESOLVED_TAG}"
          else
            RESOLVED_TAG="$INPUT_TAG"
            echo "âœ… Using explicit tag: ${RESOLVED_TAG}"
          fi
          
          # Validate image exists in Docker Hub
          echo "ğŸ” Validating image exists: ${DOCKER_REPO}:${RESOLVED_TAG}"
          
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${DOCKER_REPO}:pull" \
            | jq -r '.token')
          
          IMAGE_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${TOKEN}" \
            "https://registry-1.docker.io/v2/${DOCKER_REPO}/manifests/${RESOLVED_TAG}")
          
          if [ "$IMAGE_EXISTS" = "200" ]; then
            echo "âœ… Image validated: ${DOCKER_REPO}:${RESOLVED_TAG}"
            echo "resolved_tag=${RESOLVED_TAG}" >> $GITHUB_OUTPUT
            echo "full_image=${DOCKER_REPO}:${RESOLVED_TAG}" >> $GITHUB_OUTPUT
          else
            echo "âŒ Image not found: ${DOCKER_REPO}:${RESOLVED_TAG}"
            echo "   HTTP Status: ${IMAGE_EXISTS}"
            echo "   Please build the image first or use an existing tag"
            exit 1
          fi

      - name: Submit Argo Workflow
        id: submit
        run: |
          WORKFLOW_NAME=${{ inputs.model_name }}-$(date +%s)

          cat <<EOF | ~/.local/bin/kubectl create -n ai -f -
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: ${{ inputs.model_name }}-
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
              model: "${{ inputs.model_name }}"
          spec:
            serviceAccountName: workflow-executor
            workflowTemplateRef:
              name: mlops-pipeline
            arguments:
              parameters:
              - name: model_name
                value: "${{ inputs.model_name }}"
              - name: experiment_name
                value: "${{ inputs.experiment_name }}"
              - name: dvc_data_version
                value: "${{ inputs.dvc_data_version }}"
              - name: compute_type
                value: "${{ inputs.compute_type }}"
              - name: approval_mode
                value: "${{ inputs.approval_mode }}"
              - name: comparison_metric
                value: "${{ inputs.comparison_metric }}"
              - name: higher_is_better
                value: "${{ inputs.higher_is_better }}"
              - name: comparison_higher_is_better
                value: "${{ inputs.comparison_higher_is_better }}"
              - name: training_image
                value: "${{ steps.resolve_image.outputs.full_image }}"
              - name: training_entrypoint
                value: "${{ inputs.training_entrypoint }}"
              - name: training_args
                value: "${{ inputs.training_args }}"
          EOF

          # Get the actual workflow name
          sleep 2
          ACTUAL_NAME=$(~/.local/bin/kubectl get workflows -n ai -l repo=${{ github.event.repository.name }},run-id=${{ github.run_id }} -o jsonpath='{.items[0].metadata.name}')
          echo "workflow_name=${ACTUAL_NAME}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Provide Monitoring Links
        run: |
          WORKFLOW_NAME=${{ steps.submit.outputs.workflow_name }}
          
          echo "========================================="
          echo "ğŸš€ WORKFLOW SUBMITTED: ${WORKFLOW_NAME}"
          echo "ğŸ¯ Model: ${{ inputs.model_name }}"
          echo "ğŸ§ª Experiment: ${{ inputs.experiment_name }}"
          echo "ğŸ·ï¸  Image: ${{ steps.resolve_image.outputs.full_image }}"
          echo "ğŸ“Š Data Version: ${{ inputs.dvc_data_version }}"
          echo "ğŸ”§ Approval: ${{ inputs.approval_mode }}"
          echo "========================================="
          echo ""
          echo "ğŸ“Š MONITORING:"
          echo ""
          echo "ğŸŒ Argo Workflow:"
          echo "   https://argo.ai.internal.opencloudhub.org/workflows/ai/${WORKFLOW_NAME}"
          echo ""
          echo "ğŸ”¬ MLflow UI:"
          echo "   https://mlflow.ai.internal.opencloudhub.org"
          echo "   â†’ Navigate to experiment: ${{ inputs.experiment_name }}"
          echo ""
          echo "========================================="
          echo ""
          echo "ğŸ”§ DIRECT CLUSTER ACCESS (if available):"
          echo ""
          echo "ğŸ“‹ Check workflow status:"
          echo "   kubectl get workflow -n ai ${WORKFLOW_NAME}"
          echo ""
          echo "ğŸ“ Stream logs:"
          echo "   kubectl logs -n ai -l workflows.argoproj.io/workflow=${WORKFLOW_NAME} -f"
          echo ""
          echo "âœ… Approve workflow (if manual approval):"
          echo "   argo resume -n ai ${WORKFLOW_NAME}"
          echo ""
          echo "========================================"
