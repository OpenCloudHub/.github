name: Shared MLOPS Pipeline

on:
  workflow_call:
    inputs:
      model_name:
        description: 'Model name (e.g., wine-classifier)'
        required: true
        type: string
      dvc_data_version:
        description: "Data version to use for training (latest or specific like v1.0.0)"
        required: false
        type: string
        default: 'latest'
      dvc_dataset:
        description: "Dataset name in DVC registry"
        required: true
        type: string
      experiment_name:
        description: 'MLflow experiment name'
        required: true
        type: string
      training_entrypoint:
        description: 'Training script entrypoint'
        required: true
        type: string
      training_args:
        description: 'Additional training arguments'
        required: false
        type: string
        default: ''
      training_image_tag:
        description: 'Training image tag (latest or specific like abc1234)'
        required: false
        type: string
        default: 'latest'
      serving_image_tag:
        description: 'Serving image tag (latest or specific like abc1234)'
        required: false
        type: string
        default: 'latest'
      compute_type:
        description: 'Compute configuration'
        required: true
        type: string
      approval_mode:
        description: 'Approval mode (manual or automatic)'
        required: false
        type: string
        default: 'manual'
      comparison_metric:
        description: 'Metric to compare (accuracy, f1_score, etc.)'
        required: false
        type: string
        default: 'accuracy'
      comparison_higher_is_better:
        description: 'Whether higher metric values are better (true/false)'
        required: false
        type: boolean
        default: true
      comparison_threshold:
        description: 'Minimum improvement threshold (e.g., 0.05 = 5%)'
        required: false
        type: string
        default: '0.05'

jobs:
  submit-workflow:
    name: üöÄ Submit ML Lifecycle Workflow
    runs-on: self-hosted-local
    steps:
      # =========================================================================
      # Setup
      # =========================================================================
      - name: üîß Setup kubectl
        uses: OpenCloudHub/.github/.github/actions/setup-kubectl@main
        with:
          kube-config: ${{ secrets.KUBE_CONFIG }}

      # =========================================================================
      # Resolve versions
      # =========================================================================
      - name: üìä Resolve DVC data version
        id: data
        uses: OpenCloudHub/.github/.github/actions/resolve-dvc-version@main
        with:
          dataset: ${{ inputs.dvc_dataset }}
          version: ${{ inputs.dvc_data_version }}
          dvc-repo: ${{ vars.DVC_REPO_URL }}

      - name: üê≥ Resolve training image
        id: training
        uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          token: ${{ secrets.DOCKER_TOKEN }}
          repo: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.model_name }}-training
          prefix: main
          tag: ${{ inputs.training_image_tag }}

      - name: üê≥ Resolve serving image
        id: serving
        uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          token: ${{ secrets.DOCKER_TOKEN }}
          repo: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.model_name }}-serving
          prefix: main
          tag: ${{ inputs.serving_image_tag }}

      # =========================================================================
      # Submit workflow
      # =========================================================================
      - name: üöÄ Submit Argo Workflow
        id: submit
        run: |
          cat <<EOF | kubectl create -n mlops -f -
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: ${{ inputs.model_name }}-
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
              model: "${{ inputs.model_name }}"
          spec:
            serviceAccountName: workflow-executor
            workflowTemplateRef:
              name: mlops-pipeline
            arguments:
              parameters:
              - name: model_name
                value: "${{ inputs.model_name }}"
              - name: experiment_name
                value: "${{ inputs.experiment_name }}"
              - name: dvc_data_version
                value: "${{ steps.data.outputs.full-tag }}"
              - name: compute_type
                value: "${{ inputs.compute_type }}"
              - name: approval_mode
                value: "${{ inputs.approval_mode }}"
              - name: comparison_metric
                value: "${{ inputs.comparison_metric }}"
              - name: comparison_higher_is_better
                value: "${{ inputs.comparison_higher_is_better }}"
              - name: comparison_threshold
                value: "${{ inputs.comparison_threshold }}"
              - name: training_image
                value: "${{ steps.training.outputs.full-image }}"
              - name: serving_image
                value: "${{ steps.serving.outputs.full-image }}"
              - name: training_entrypoint
                value: "${{ inputs.training_entrypoint }}"
              - name: training_args
                value: "${{ inputs.training_args }}"
          EOF

          # Get the actual workflow name
          sleep 2
          ACTUAL_NAME=$(kubectl get workflows -n mlops -l repo=${{ github.event.repository.name }},run-id=${{ github.run_id }} -o jsonpath='{.items[0].metadata.name}')
          echo "workflow_name=${ACTUAL_NAME}" >> $GITHUB_OUTPUT

      # =========================================================================
      # Summary
      # =========================================================================
      - name: üìä Summary
        run: |
          WORKFLOW_NAME=${{ steps.submit.outputs.workflow_name }}

          echo "## üöÄ ML Workflow Submitted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | \`${WORKFLOW_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Model** | \`${{ inputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Experiment** | \`${{ inputs.experiment_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Data Version** | \`${{ steps.data.outputs.full-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Training Image** | \`${{ steps.training.outputs.full-image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Serving Image** | \`${{ steps.serving.outputs.full-image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compute** | \`${{ inputs.compute_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Approval** | \`${{ inputs.approval_mode }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Argo Workflow](https://argo-workflows.internal.opencloudhub.org/workflows/mlops/${WORKFLOW_NAME})" >> $GITHUB_STEP_SUMMARY
          echo "- [MLflow Experiment](https://mlflow.internal.opencloudhub.org/#/experiments)" >> $GITHUB_STEP_SUMMARY
