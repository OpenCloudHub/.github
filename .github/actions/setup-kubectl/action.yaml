# =============================================================================
# Setup kubectl - Composite Action
# =============================================================================
#
# Installs and configures kubectl for Kubernetes cluster access in CI/CD.
# Used by MLOps pipelines to submit Argo Workflows to the cluster.
#
# Features
# --------
# - Installs kubectl if not present (downloads stable release)
# - Configures kubeconfig from base64-encoded secret
# - Optional cluster connectivity verification
# - Idempotent: skips installation if kubectl already exists
#
# Security Notes
# --------------
# - kubeconfig is stored in ~/.kube/config with 600 permissions
# - Use short-lived, scoped service account tokens when possible
# - The verify step confirms cluster access before proceeding
#
# Inputs
# ------
# kube-config : Base64 encoded kubeconfig content (required)
# verify      : Test cluster connectivity (default: true)
#
# Outputs
# -------
# kubectl-path : Path to kubectl binary
#
# Usage
# -----
#   - uses: OpenCloudHub/.github/.github/actions/setup-kubectl@main
#     with:
#       kube-config: ${{ secrets.KUBE_CONFIG }}
#
#   - run: kubectl get pods -n mlops
#
# Creating the Secret
# -------------------
#   # On your local machine with cluster access:
#   cat ~/.kube/config | base64 -w0 > kube-config-b64.txt
#   # Add to GitHub Secrets as KUBE_CONFIG
#
# See Also
# --------
# - shared-mlops-pipeline.yaml : Primary consumer of this action
# =============================================================================

name: "Setup kubectl"
description: "Install and configure kubectl with cluster access"

inputs:
  kube-config:
    description: "Base64 encoded kubeconfig"
    required: true
  verify:
    description: "Verify cluster connectivity"
    required: false
    default: "true"

outputs:
  kubectl-path:
    description: "Path to kubectl binary"
    value: ${{ steps.install.outputs.kubectl-path }}

runs:
  using: "composite"
  steps:
    - name: ğŸ”§ Install kubectl
      id: install
      shell: bash
      run: |
        if command -v kubectl &> /dev/null; then
          echo "âœ… kubectl already installed: $(which kubectl)"
          echo "kubectl-path=$(which kubectl)" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“¦ Installing kubectl..."
          curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p ~/.local/bin
          mv kubectl ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "kubectl-path=$HOME/.local/bin/kubectl" >> $GITHUB_OUTPUT
          echo "âœ… kubectl installed"
        fi

    - name: ğŸ” Configure kubectl
      shell: bash
      run: |
        mkdir -p ~/.kube
        echo "${{ inputs.kube-config }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        echo "âœ… kubeconfig configured"

    - name: ğŸ” Verify cluster connectivity
      if: inputs.verify == 'true'
      shell: bash
      run: |
        echo "ğŸ” Verifying cluster connectivity..."
        if ! kubectl get nodes --request-timeout=10s > /dev/null 2>&1; then
          echo "âŒ Failed to connect to cluster"
          exit 1
        fi
        echo "âœ… Cluster connection verified"
