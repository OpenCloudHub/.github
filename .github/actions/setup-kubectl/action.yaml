# .github/actions/setup-kubectl/action.yaml
name: 'Setup kubectl'
description: 'Install and configure kubectl with cluster access'

inputs:
  kube-config:
    description: 'Base64 encoded kubeconfig'
    required: true
  verify:
    description: 'Verify cluster connectivity'
    required: false
    default: 'true'

outputs:
  kubectl-path:
    description: 'Path to kubectl binary'
    value: ${{ steps.install.outputs.kubectl-path }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ Install kubectl
      id: install
      shell: bash
      run: |
        if command -v kubectl &> /dev/null; then
          echo "âœ… kubectl already installed: $(which kubectl)"
          echo "kubectl-path=$(which kubectl)" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“¦ Installing kubectl..."
          curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mkdir -p ~/.local/bin
          mv kubectl ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "kubectl-path=$HOME/.local/bin/kubectl" >> $GITHUB_OUTPUT
          echo "âœ… kubectl installed"
        fi

    - name: ğŸ” Configure kubectl
      shell: bash
      run: |
        mkdir -p ~/.kube
        echo "${{ inputs.kube-config }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        echo "âœ… kubeconfig configured"

    - name: ğŸ” Verify cluster connectivity
      if: inputs.verify == 'true'
      shell: bash
      run: |
        echo "ğŸ” Verifying cluster connectivity..."
        if ! kubectl cluster-info --request-timeout=10s; then
          echo "âŒ Failed to connect to cluster"
          exit 1
        fi
        echo "âœ… Cluster connection verified"
