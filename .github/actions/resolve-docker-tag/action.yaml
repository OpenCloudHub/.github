# =============================================================================
# Resolve Docker Tag - Composite Action
# =============================================================================
#
# Resolves Docker image tags for deployment workflows. Supports finding the
# tag that matches 'latest' or validating specific tags exist.
#
# Problem Solved
# --------------
# When deploying, we want reproducibility (specific SHA tags) but also
# convenience ('latest'). This action bridges both by:
# 1. Finding which {prefix}-{sha} tag matches 'latest' digest
# 2. Validating that explicitly requested tags exist before deploying
#
# Algorithm
# ---------
# If tag='latest':
#   1. Get digest of 'latest' tag
#   2. List all {prefix}-* tags
#   3. Find which tag has matching digest
#   4. Return that tag (e.g., 'main-abc1234')
#
# If tag is specific (e.g., 'abc1234'):
#   1. Check if {prefix}-{tag} exists
#   2. Fail fast if not found with helpful suggestions
#
# Inputs
# ------
# username : Docker registry username (for private repos)
# token    : Docker registry token (for private repos)
# repo     : Full repo name (e.g., 'opencloudhub/wine-classifier-training')
# prefix   : Tag prefix to search (e.g., 'main', 'pr')
# tag      : 'latest' or specific suffix (e.g., 'abc123')
# registry : Container registry (default: 'docker.io')
#
# Outputs
# -------
# resolved-tag : The resolved tag (e.g., 'main-abc123')
# full-image   : Complete image reference (e.g., 'repo:main-abc123')
# digest       : Image digest for verification
#
# Usage
# -----
#   - uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
#     with:
#       username: ${{ secrets.DOCKER_USERNAME }}
#       token: ${{ secrets.DOCKER_TOKEN }}
#       repo: opencloudhub/my-service
#       prefix: main
#       tag: latest
#
# See Also
# --------
# - shared-ci-docker-build-push.yaml : Builds and tags images
# - shared-mlops-pipeline.yaml : Uses this action for deployments
# =============================================================================

name: "Resolve Docker Tag"
description: "Resolve Docker image tags - validates explicit tags or finds latest for a prefix"

inputs:
  username:
    description: "Docker registry username (required for private repos)"
    required: false
    default: ""
  token:
    description: "Docker registry token/password (required for private repos)"
    required: false
    default: ""
  repo:
    description: "Docker repository (e.g., opencloudhuborg/wine-classifier-training)"
    required: true
  prefix:
    description: "Tag prefix (e.g., main, pr)"
    required: true
  tag:
    description: 'Tag to resolve - "latest" to find most recent, or specific suffix (e.g., abc123)'
    required: true
    default: "latest"
  registry:
    description: "Container registry (docker.io, ghcr.io)"
    required: false
    default: "docker.io"

outputs:
  resolved-tag:
    description: "Resolved tag (e.g., main-abc123)"
    value: ${{ steps.resolve.outputs.resolved-tag }}
  full-image:
    description: "Full image reference (e.g., opencloudhuborg/wine-classifier:main-abc123)"
    value: ${{ steps.resolve.outputs.full-image }}
  digest:
    description: "Image digest"
    value: ${{ steps.resolve.outputs.digest }}

runs:
  using: "composite"
  steps:
    - name: ðŸ” Resolve Docker tag
      id: resolve
      shell: bash
      env:
        INPUT_USERNAME: ${{ inputs.username }}
        INPUT_TOKEN: ${{ inputs.token }}
      run: |
        REPO="${{ inputs.repo }}"
        PREFIX="${{ inputs.prefix }}"
        TAG="${{ inputs.tag }}"
        REGISTRY="${{ inputs.registry }}"

        echo "ðŸ” Resolving image tag..."
        echo "   Repository: ${REPO}"
        echo "   Prefix: ${PREFIX}"
        echo "   Tag: ${TAG}"
        echo "   Registry: ${REGISTRY}"
        echo "   Auth: ${INPUT_USERNAME:+provided}${INPUT_USERNAME:-anonymous}"
        echo ""

        # Get registry token
        if [ "${REGISTRY}" = "docker.io" ]; then
          REGISTRY_URL="https://registry-1.docker.io/v2"

          if [ -n "${INPUT_USERNAME}" ] && [ -n "${INPUT_TOKEN}" ]; then
            # Authenticated request for private repos
            echo "ðŸ” Using authenticated access..."
            TOKEN=$(curl -s \
              -u "${INPUT_USERNAME}:${INPUT_TOKEN}" \
              "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${REPO}:pull" \
              | jq -r '.token')
          else
            # Anonymous access for public repos
            TOKEN=$(curl -s \
              "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${REPO}:pull" \
              | jq -r '.token')
          fi

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ Failed to obtain registry token"
            echo "   If this is a private repository, make sure username and token are provided."
            exit 1
          fi
        elif [ "${REGISTRY}" = "ghcr.io" ]; then
          echo "âŒ ghcr.io not yet supported"
          exit 1
        else
          echo "âŒ Unsupported registry: ${REGISTRY}"
          exit 1
        fi

        # Function to get manifest digest
        get_digest() {
          local tag=$1
          curl -s -I \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json, application/vnd.oci.image.manifest.v1+json" \
            "${REGISTRY_URL}/${REPO}/manifests/${tag}" \
            | grep -i "docker-content-digest" | awk '{print $2}' | tr -d '\r'
        }

        # Function to check if tag exists
        tag_exists() {
          local tag=$1
          local status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            "${REGISTRY_URL}/${REPO}/manifests/${tag}")
          [ "$status" = "200" ]
        }

        # Check if repository exists at all
        REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer ${TOKEN}" \
          "${REGISTRY_URL}/${REPO}/tags/list")

        if [ "$REPO_CHECK" = "404" ]; then
          echo "âŒ Repository not found: ${REPO}"
          echo "   Make sure the repository exists and is accessible."
          exit 1
        elif [ "$REPO_CHECK" != "200" ]; then
          echo "âŒ Failed to access repository: ${REPO} (HTTP ${REPO_CHECK})"
          exit 1
        fi

        if [ "${TAG}" = "latest" ]; then
          # Find the prefixed tag that matches 'latest' digest
          echo "ðŸ” Finding ${PREFIX}-* tag matching 'latest'..."

          LATEST_DIGEST=$(get_digest "latest")

          if [ -z "$LATEST_DIGEST" ]; then
            echo "âŒ Could not find 'latest' tag for ${REPO}"
            echo "   Make sure an image is tagged as 'latest'."
            exit 1
          fi

          echo "ðŸ“¦ Latest digest: ${LATEST_DIGEST}"

          # Get all tags with the specified prefix
          ALL_TAGS=$(curl -s \
            -H "Authorization: Bearer ${TOKEN}" \
            "${REGISTRY_URL}/${REPO}/tags/list" \
            | jq -r '.tags[]?' 2>/dev/null | grep "^${PREFIX}-" | sort -r || echo "")

          if [ -z "$ALL_TAGS" ]; then
            echo "âŒ No ${PREFIX}-* tags found for ${REPO}"
            echo "   Available tags:"
            curl -s \
              -H "Authorization: Bearer ${TOKEN}" \
              "${REGISTRY_URL}/${REPO}/tags/list" \
              | jq -r '.tags[]?' 2>/dev/null | head -20 || echo "   (none)"
            exit 1
          fi

          # Find matching tag
          RESOLVED_TAG=""
          for candidate in $ALL_TAGS; do
            CANDIDATE_DIGEST=$(get_digest "$candidate")
            if [ "$CANDIDATE_DIGEST" = "$LATEST_DIGEST" ]; then
              RESOLVED_TAG="$candidate"
              echo "âœ… Found matching tag: ${RESOLVED_TAG}"
              break
            fi
          done

          if [ -z "$RESOLVED_TAG" ]; then
            echo "âŒ Could not find ${PREFIX}-* tag matching 'latest' digest"
            echo "   This can happen if 'latest' was built separately from ${PREFIX}-* tags."
            echo "   Available ${PREFIX}-* tags:"
            echo "$ALL_TAGS" | head -10
            exit 1
          fi

          DIGEST="$LATEST_DIGEST"

        else
          # Explicit tag - validate it exists
          RESOLVED_TAG="${PREFIX}-${TAG}"
          echo "ðŸ” Validating explicit tag: ${RESOLVED_TAG}"

          if ! tag_exists "$RESOLVED_TAG"; then
            echo "âŒ Tag not found: ${REPO}:${RESOLVED_TAG}"
            echo ""
            echo "   Available ${PREFIX}-* tags:"
            curl -s \
              -H "Authorization: Bearer ${TOKEN}" \
              "${REGISTRY_URL}/${REPO}/tags/list" \
              | jq -r '.tags[]?' 2>/dev/null | grep "^${PREFIX}-" | sort -r | head -10 || echo "   (none)"
            exit 1
          fi

          DIGEST=$(get_digest "$RESOLVED_TAG")
          echo "âœ… Tag exists: ${RESOLVED_TAG}"
        fi

        FULL_IMAGE="${REPO}:${RESOLVED_TAG}"

        echo ""
        echo "âœ… Resolved image: ${FULL_IMAGE}"
        echo "   Digest: ${DIGEST}"

        echo "resolved-tag=${RESOLVED_TAG}" >> $GITHUB_OUTPUT
        echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
        echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
